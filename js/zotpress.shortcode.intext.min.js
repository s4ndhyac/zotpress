jQuery(document).ready(function()
{if(jQuery(".zp-Zotpress-InTextBib").length>0)
{window.zpIntextCitations={};window.zpIntextCitationCount=0;jQuery(".zp-Zotpress-InTextBib").each(function(index,instance)
{var $instance=jQuery(instance);var zp_params={};window.zpIntextCitations["post-"+jQuery(".ZP_POSTID",$instance).text()]={};zp_params.zpItemkey=!1;if(jQuery(".ZP_ITEM_KEY",$instance).text().trim().length>0)zp_params.zpItemkey=jQuery(".ZP_ITEM_KEY",$instance).text();zp_params.zpStyle=!1;if(jQuery(".ZP_STYLE",$instance).text().trim().length>0)zp_params.zpStyle=jQuery(".ZP_STYLE",$instance).text();zp_params.zpTitle=!1;if(jQuery(".ZP_TITLE",$instance).text().trim().length>0)zp_params.zpTitle=jQuery(".ZP_TITLE",$instance).text();zp_params.zpShowImages=!1;if(jQuery(".ZP_SHOWIMAGE",$instance).text().trim().length>0)zp_params.zpShowImages=jQuery(".ZP_SHOWIMAGE",$instance).text().trim();zp_params.zpShowTags=!1;if(jQuery(".ZP_SHOWTAGS",$instance).text().trim().length>0)zp_params.zpShowTags=!0;zp_params.zpDownloadable=!1;if(jQuery(".ZP_DOWNLOADABLE",$instance).text().trim().length>0)zp_params.zpDownloadable=!0;zp_params.zpShowNotes=!1;if(jQuery(".ZP_NOTES",$instance).text().trim().length>0)zp_params.zpShowNotes=!0;zp_params.zpShowAbstracts=!1;if(jQuery(".ZP_ABSTRACT",$instance).text().trim().length>0)zp_params.zpShowAbstracts=!0;zp_params.zpCiteable=!1;if(jQuery(".ZP_CITEABLE",$instance).text().trim().length>0)zp_params.zpCiteable=!0;zp_params.zpTarget=!1;if(jQuery(".ZP_TARGET",$instance).text().trim().length>0)zp_params.zpTarget=!0;zp_params.zpURLWrap=!1;if(jQuery(".ZP_URLWRAP",$instance).text().trim().length>0)zp_params.zpURLWrap=jQuery(".ZP_URLWRAP",$instance).text();zp_params.zpHighlight=!1;if(jQuery(".ZP_HIGHLIGHT",$instance).text().trim().length>0)zp_params.zpHighlight=jQuery(".ZP_HIGHLIGHT",$instance).text();zp_get_items(0,0,$instance,zp_params,!1)})}
function zp_get_items(request_start,request_last,$instance,params,update)
{if(typeof(request_start)==="undefined"||request_start=="false"||request_start=="")
request_start=0;if(typeof(request_last)==="undefined"||request_last=="false"||request_last=="")
request_last=0;jQuery.ajax({url:zpShortcodeAJAX.ajaxurl,ifModified:!0,data:{'action':'zpRetrieveViaShortcode','instance_id':$instance.attr("id"),'api_user_id':jQuery(".ZP_API_USER_ID",$instance).text(),'type':"intext",'item_key':params.zpItemkey,'style':params.zpStyle,'title':params.zpTitle,'showimage':params.zpShowImages,'showtags':params.zpShowTags,'downloadable':params.zpDownloadable,'shownotes':params.zpShowNotes,'showabstracts':params.zpShowAbstracts,'citeable':params.zpCiteable,'target':params.zpTarget,'urlwrap':params.zpURLWrap,'highlight':params.zpHighlight,'sort_by':jQuery(".ZP_SORTBY",$instance).text(),'order':jQuery(".ZP_ORDER",$instance).text(),'update':update,'request_start':request_start,'request_last':request_last,'zpShortcode_nonce':zpShortcodeAJAX.zpShortcode_nonce},xhrFields:{withCredentials:!0},success:function(data)
{var zp_items=jQuery.parseJSON(data);if(typeof zp_items!='undefined'&&zp_items!=null&&parseInt(zp_items)!=0&&zp_items.data.length>0)
{var tempItems="";if(params.zpShowNotes==!0)var tempNotes="";if(params.zpTitle==!0)var tempTitle="";var $postRef=jQuery($instance).parent();if(update===!1)
{jQuery("#"+zp_items.instance+" .zp-List").addClass("used_cache")}
else if(update===!0)
{if(!jQuery("#"+zp_items.instance+" .zp-List").hasClass("updating")&&jQuery("#"+zp_items.instance+" .zp-Citation-Notes").length>0)
jQuery("#"+zp_items.instance+" .zp-Citation-Notes").remove();if(!jQuery("#"+zp_items.instance+" .zp-List").hasClass("updating"))
jQuery("#"+zp_items.instance+" .zp-List").addClass("updating")}
zp_format_intext_citations($instance,params.zpItemkey,zp_items.data,params,update);tempItems=zp_format_intextbib($instance,zp_items,params.zpItemkey,params,update);if(update===!1)jQuery("#"+zp_items.instance+" .zp-List").append(tempItems);if(params.zpShowNotes==!0&&tempNotes.length>0)
{tempNotes="<div class='zp-Citation-Notes'>\n<h4>Notes</h4>\n<ol>\n"+tempNotes;tempNotes=tempNotes+"</ol>\n</div><!-- .zp-Citation-Notes -->\n\n";jQuery("#"+zp_items.instance).append(tempNotes)}
if(zp_items.meta.request_next!=!1&&zp_items.meta.request_next!="false")
{zp_get_items(zp_items.meta.request_next,zp_items.meta.request_last,$instance,params,update)}
else{jQuery("#"+zp_items.instance+" .zp-List").removeClass("loading");if(!jQuery("#"+zp_items.instance+" .zp-List").hasClass("updating"))
{zp_get_items(0,0,$instance,params,!0)}
else{var sortby=jQuery(".ZP_SORTBY",$instance).text();var orderby=jQuery(".ZP_ORDER",$instance).text();if(["author","date"].indexOf(sortby)!==-1&&jQuery("#"+zp_items.instance+" .zp-List .csl-left-margin").length==0)
{var sortOrder="data-zp-author-year";if(sortby=="date")sortOrder="data-zp-year-author";jQuery("#"+zp_items.instance+" .zp-List div.zp-Entry").sort(function(a,b)
{var an=a.getAttribute(sortOrder).toLowerCase(),bn=b.getAttribute(sortOrder).toLowerCase();if(an>bn)
if(orderby=="asc")
return 1;else return-1;else if(an<bn)
if(orderby=="asc")
return-1;else return 1;else return 0}).detach().appendTo("#"+zp_items.instance+" .zp-List")}}}}
else{var tempPost=$instance.attr("class");tempPost=tempPost.replace("zp-Zotpress zp-Zotpress-InTextBib zp-Post-","");if(jQuery("#post-"+tempPost).length>0)
jQuery("#post-"+tempPost+" .zp-InText-Citation").removeClass("loading").remove();else jQuery("#"+$instance.attr("id")).parent().find(".zp-InText-Citation").removeClass("loading").remove();jQuery("#"+$instance.attr("id")+" .zp-List").removeClass("loading");jQuery("#"+$instance.attr("id")+" .zp-List").append("<p>There are no citations to display.</p>\n")}},error:function(errorThrown)
{console.log("Zotpress Error:");console.log(errorThrown)}})}
function zp_format_intext_citations($instance,item_keys,item_data,params,update)
{var intext_citations=[];if(item_keys.indexOf(";")!=-1)intext_citations=item_keys.split(";");else intext_citations.push(item_keys);var tempItem_data={};jQuery.each(item_data,function(index,value)
{if(!tempItem_data.hasOwnProperty(value.key))
tempItem_data[value.key]=value});item_data=tempItem_data;jQuery.each(intext_citations,function(index,intext_citation)
{var $postRef=jQuery($instance).parent();var tempId=intext_citation.replace(/{/g,"-").replace(/}/g,"-").replace(/,/g,"_").replace(/\//g,"_").replace(/\+/g,"_").replace(/&/g,"_").replace(/ /g,"_");var intext_citation_id="zp-InText-zp-ID-"+jQuery(".ZP_API_USER_ID",$instance).text()+"-"+tempId+"-"+jQuery(".ZP_POSTID",$instance).text()+"-"+(index+1);var intext_citation_params=JSON.parse(jQuery("#"+intext_citation_id,$postRef).attr("rel").replace(/'/g,'"'));var intext_citation_output="";if(intext_citation.indexOf("{")!=-1)
{if(intext_citation.indexOf("},")!=-1)
{intext_citation=intext_citation.split("},");jQuery.each(intext_citation,function(id,item)
{if(item.indexOf(",")!=-1)
{item=item.split(",");intext_citation[id]={"key":item[0].replace("}","").replace("{",""),"api_user_id":jQuery(".ZP_API_USER_ID",$instance).text(),"post_id":jQuery(".ZP_POSTID",$instance).text(),"pages":item[1].replace("}",""),"bib":"","citation_ids":""}}
else{intext_citation[id]={"key":item.replace("}","").replace("{",""),"api_user_id":jQuery(".ZP_API_USER_ID",$instance).text(),"post_id":jQuery(".ZP_POSTID",$instance).text(),"pages":!1,"bib":"","citation_ids":""}}})}
else{if(intext_citation.indexOf(",")!=-1)
{var item=intext_citation.split(",");intext_citation=[{"key":item[0].replace("}","").replace("{",""),"api_user_id":jQuery(".ZP_API_USER_ID",$instance).text(),"post_id":jQuery(".ZP_POSTID",$instance).text(),"pages":item[1].replace("}",""),"bib":"","citation_ids":""}]}
else{intext_citation=[{"key":intext_citation.replace("}","").replace("{",""),"api_user_id":jQuery(".ZP_API_USER_ID",$instance).text(),"post_id":jQuery(".ZP_POSTID",$instance).text(),"pages":!1,"bib":"","citation_ids":""}]}}}
else{intext_citation=[{"key":intext_citation,"api_user_id":jQuery(".ZP_API_USER_ID",$instance).text(),"post_id":jQuery(".ZP_POSTID",$instance).text(),"pages":!1,"bib":"","citation_ids":""}]}
var group_authors=[];jQuery.each(intext_citation,function(cindex,item)
{var item_citation="";var item_authors="";var item_year="";if(!window.zpIntextCitations["post-"+item.post_id].hasOwnProperty(item.key))
{window.zpIntextCitations["post-"+item.post_id][item.key]=item;window.zpIntextCitationCount++;window.zpIntextCitations["post-"+item.post_id][item.key].num=window.zpIntextCitationCount}
if(item_data.hasOwnProperty(item.key))
{if(item_data[item.key].data.hasOwnProperty("creators"))
{var tempAuthorCount=0;jQuery.each(item_data[item.key].data.creators,function(ai,author)
{if(["bookSection","encyclopediaArticle"].indexOf(item_data[item.key].data.itemType)!==!1&&author.creatorType=="editor")
return!0;tempAuthorCount++;if(ai!=0&&tempAuthorCount>1)item_authors+=", ";if(author.hasOwnProperty("name"))item_authors+=author.name;else if(author.hasOwnProperty("lastName"))item_authors+=author.lastName});if(group_authors.indexOf(item_authors)==-1)
group_authors[group_authors.length]=item_authors;else item_authors="";item_authors=item_authors.split(", ");if(jQuery.isArray(item_authors)&&item_authors.length>2)
{if(intext_citation_params.etal==""||intext_citation_params.etal=="default")
{if(update==!1&&window.zpIntextCitations["post-"+item.post_id][item.key].citation_ids.length>1)
item_authors=item_authors[0]+" <em>et al.</em>"}
else if(intext_citation_params.etal=="yes")
{item_authors=item_authors[0]+" <em>et al.</em>"}}
if(jQuery.isArray(item_authors)&&item_authors.length>1)
{if(item_authors.indexOf("et al")==-1)
{var temp_and=", ";if(intext_citation_params.and==""||intext_citation_params.and=="and"||intext_citation_params.and=="comma-and")
{if(intext_citation_params.and=="")temp_and=" and ";else if(intext_citation_params.and=="and")temp_and=" and ";else if(intext_citation_params.and=="comma-and")temp_and=", and ";var temp=item_authors.join().replace(/,/g,", ");item_authors=temp.substring(0,temp.lastIndexOf(", "))+temp_and+item_authors[item_authors.length-1]}}}}
else{item_authors+=item_data[item.key].data.title}
if(item_data[item.key].meta.hasOwnProperty("parsedDate"))
item_year=item_data[item.key].meta.parsedDate.substring(0,4);else item_year="n.d.";window.zpIntextCitations["post-"+item.post_id][item.key].intexttitle="title='"+JSON.stringify(item_authors).replace("<em>et al.</em>","et al.").replace(/\"/g,"").replace("[","").replace("]","")+" ("+item_year+"). "+item_data[item.key].data.title+".' "}
if(intext_citation_params.format.indexOf("%num%")!=-1)
{var default_format=intext_citation_params.format;var item_citation_num=window.zpIntextCitations["post-"+item.post_id][item.key].num;item_citation=intext_citation_params.format.replace("%num%",item_citation_num);if(item.pages!=!1)
{var multip="p. ";if(item.pages.indexOf("-")!=-1)multip="pp. ";item_citation=item_citation.replace("%p%",multip+item.pages)}
else{item_citation=item_citation.replace(", %p%","")}
if(intext_citation.length>1)
{if(cindex!=intext_citation.length-1)
item_citation=item_citation.replace(")","");if(cindex!=0)
if(item_authors=="")
item_citation=item_citation.replace("(, ","");else item_citation=item_citation.replace("(","")}
if(intext_citation_params.brackets)
{item_citation=item_citation.replace("(","");item_citation=item_citation.replace(")","")}}
else{var default_format=intext_citation_params.format;item_citation=intext_citation_params.format.replace("%a%",item_authors);item_citation=item_citation.replace("%d%",item_year);if(item.pages==!1)
{item_citation=item_citation.replace(", %p%","");item_citation=item_citation.replace("%p%","")}
else{item_citation=item_citation.replace("%p%",item.pages)}
if(default_format=="(%a%, %d%, %p%)"&&intext_citation.length>1)
{if(cindex!=intext_citation.length-1)
item_citation=item_citation.replace(")","");if(cindex!=0)
if(item_authors=="")
item_citation=item_citation.replace("(, ","");else item_citation=item_citation.replace("(","")}}
if(!window.zpIntextCitations["post-"+item.post_id][item.key].hasOwnProperty("intexttitle"))
window.zpIntextCitations["post-"+item.post_id][item.key].intexttitle="";item_citation="<a "+window.zpIntextCitations["post-"+item.post_id][item.key].intexttitle+"class='zp-ZotpressInText' href='#zp-ID-"+item.post_id+"-"+item.api_user_id+"-"+item.key+"'>"+item_citation+"</a>";if(intext_citation_params.format.indexOf("sup")!="-1")item_citation="<sup>"+item_citation+"</sup>";intext_citation[cindex].intext=item_citation});var intext_citation_pre="";if(intext_citation_params.brackets)intext_citation_pre="[";var intext_citation_post="";if(intext_citation_params.brackets)intext_citation_post="]";intext_citation_output=intext_citation_pre;jQuery.each(intext_citation,function(cindex,item)
{if(cindex!=0)
{if(intext_citation_params.separator=="comma")
intext_citation_output+="; ";else intext_citation_output+=", "}
intext_citation_output+=item.intext});intext_citation_output+=intext_citation_post;jQuery("#"+intext_citation_id).removeClass("loading").html(intext_citation_output)})}
function zp_format_intextbib($instance,zp_items,zp_itemkeys,params,update)
{var tempItemsArr={};var tempHasNum=!1;var zpPostID=jQuery(".ZP_POSTID",$instance).text();jQuery.each(zp_items.data,function(index,item)
{var tempItem="";var $item_ref=jQuery("#"+zp_items.instance+" .zp-List #zp-ID-"+jQuery(".ZP_API_USER_ID",$instance).text()+"-"+item.key);if(jQuery("#"+zp_items.instance+" .zp-List #zp-ID-"+jQuery(".ZP_API_USER_ID",$instance).text()+"-"+item.key).length>0)
return!0;var tempItemYear="0000";if(item.meta.hasOwnProperty('parsedDate'))tempItemYear=item.meta.parsedDate.substring(0,4);var tempAuthor=item.data.title;if(item.meta.hasOwnProperty('creatorSummary'))tempAuthor=item.meta.creatorSummary.replace(/ /g,"-");if(params.zpTitle==!0&&tempTitle!=tempItemYear)
{tempTitle=tempItemYear;tempItem+="<h3>"+tempTitle+"</h3>\n"}
tempItem+="<div id='zp-ID-"+jQuery(".ZP_POSTID",$instance).text()+"-"+jQuery(".ZP_API_USER_ID",$instance).text()+"-"+item.key+"'";tempItem+=" data-zp-author-year='"+tempAuthor+"-"+tempItemYear+"' class='zp-Entry zpSearchResultsItem zp-Num-"+window.zpIntextCitations["post-"+zpPostID][item.key].num;if(update===!0)tempItem+=" zp_updated";if(jQuery("#"+zp_items.instance+" .ZP_SHOWIMAGE").text().trim().length>0&&item.hasOwnProperty('image'))
{tempItem+=" zp-HasImage'>\n";tempItem+="<div id='zp-Citation-"+item.key+"' class='zp-Entry-Image hasImage' rel='"+item.key+"'>\n";if(params.zpURLWrap=="image"&&item.data.url!="")
{tempItem+="<a href='"+item.data.url+"'";if(params.zpTarget)tempItem+=" target='_blank'";tempItem+=">"}
tempItem+="<img class='thumb' src='"+item.image[0]+"' alt='image' />\n";if(params.zpURLWrap=="image"&&item.data.url!="")tempItem+="</a>";tempItem+="</div><!-- .zp-Entry-Image -->\n"}
else{tempItem+="'>\n"}
if(jQuery("#"+zp_items.instance+" .ZP_FORCENUM").text().length>0&&jQuery("#"+zp_items.instance+" .ZP_FORCENUM").text()=="1")
{if(!/csl-left-margin/i.test(item.bib))
{item.bib=item.bib.replace('<div class="csl-entry">','<div class="csl-entry"><div class="csl-left-margin" style="display: inline;">'+window.zpIntextCitations["post-"+zpPostID][item.key].num+'. </div>')}}
if(/csl-left-margin/i.test(item.bib)||(jQuery("#"+zp_items.instance+" .ZP_FORCENUM").text().length>0&&jQuery("#"+zp_items.instance+" .ZP_FORCENUM").text()=="1"))
{tempHasNum=!0;var $item_content=jQuery.parseHTML(item.bib);var item_num_content=jQuery(".csl-left-margin",$item_content).text();item_num_content=item_num_content.replace(item_num_content.match(/\d+/)[0],window.zpIntextCitations["post-"+zpPostID][item.key].num);jQuery(".csl-left-margin",$item_content).text(item_num_content);item.bib=jQuery('<div>').append($item_content).html()}
tempItem+=item.bib;if(params.zpShowAbstracts==!0&&(item.data.hasOwnProperty('abstractNote')&&item.data.abstractNote.length>0))
tempItem+="<p class='zp-Abstract'><span class='zp-Abstract-Title'>Abstract:</span> "+item.data.abstractNote+"</p>\n";if(params.zpShowTags==!0&&(item.data.hasOwnProperty('tags')&&item.data.tags.length>0))
{tempItem+="<p class='zp-Zotpress-ShowTags'><span class='title'>Tags:</span> ";jQuery.each(item.data.tags,function(tindex,tag)
{tempItem+="<span class='tag'>"+tag.tag+"</span>";if(tindex!=(item.data.tags.length-1))tempItem+="<span class='separator'>,</span> "});tempItem+="</p>\n"}
tempItem+="</div><!-- .zp-Entry -->\n";if(params.zpShowNotes==!0&&item.hasOwnProperty('notes'))
tempNotes+=item.notes;if($item_ref.length>0&&update===!0)
$item_ref.replaceWith(jQuery(tempItem));else tempItemsArr[item.key]=tempItem});var tempItemsOrdered="";if(tempHasNum&&update===!1)
{if(jQuery("#"+zp_items.instance+" .zp-List").children().length==0)
{jQuery.each(window.zpIntextCitations["post-"+zpPostID],function(index,value)
{if(typeof tempItemsArr[index]!=='undefined')
tempItemsOrdered+=tempItemsArr[index]})}
else{jQuery.each(tempItemsArr,function(itemKey,itemBib)
{var tempNum=window.zpIntextCitations["post-"+zpPostID][itemKey].num;jQuery("#"+zp_items.instance+" .zp-List .zp-Entry.zp-Num-"+(tempNum-1)).after(itemBib)})}}
else{jQuery.each(tempItemsArr,function(index,value){tempItemsOrdered+=value})}
return tempItemsOrdered}
jQuery(".zp-InText-Citation").on("click",".zp-ZotpressInText",function()
{jQuery(jQuery(this).attr("href")).effect("highlight",{color:"#C5EFF7",easing:"easeInExpo"},1200)})})
